# use container-based infrastructure
sudo: false
dist: trusty

# Ruby configuration
language: ruby
rvm:
  - 2.5.0
cache: bundler
bundler_args: --without development --jobs=3 --retry=3

env:
  global:
    - secure: "oo9A9sstCsgWoxyo0L+PRZ313NeWSGcdgWcdmPd5fvUGs/a44NgKNFGpe9RmZtQBWVdOweYmXcw6dh4c/fSlbZyH44KK/txdGts0ax0ONEBCcazgySNjj+Yxsglu4yjndR9m1Jn088NpB0CyP7+/dV0l/VPPxTsnHWuKvoBmdis="

before_script:
  - git clone --quiet -b master https://github.com/Tosainu/tosainu.github.com.git build

script:
  - bundle exec middleman build

after_success:
  - |
    if [[ "$TRAVIS_BRANCH" != "dev" || "$TRAVIS_PULL_REQUEST" != "false" ]]; then
      exit 0;
    fi

    # setup deploy key
    declare -r SSH_FILE="$HOME/.ssh/github_deploy_key"
    openssl aes-256-cbc -K $encrypted_51c100d79015_key -iv $encrypted_51c100d79015_iv \
      -in "github_deploy_key.enc" -out "$SSH_FILE" -d
    chmod 600 "$SSH_FILE"
    echo -e "Host github.com\n\tHostName github.com\n\tUser git\n\tIdentityFile ${SSH_FILE}\n\tIdentitiesOnly yes\n" \
      >> ~/.ssh/config

    # deploy!
    bundle exec middleman deploy
